<div>
	<!-- Nav tabs -->
	<ul class="tabulator" role="tablist">
		<li role="presentation" class="active" id="EinnahmenT"><a id="EinnahmenHref" href="#einnahmen" aria-controls="einnahmen" role="tab" data-toggle="tab">Einnahmen</a></li>
		<li role="presentation" id="AusgabenT"><a id="AusgabenHref" href="#ausgaben" aria-controls="ausgaben" role="tab" data-toggle="tab">Ausgaben</a></li>
		<li role="presentation"><a href="#tabelle" aria-controls="tabelle" role="tab" data-toggle="tab">Tabelle</a></li>
		<li role="presentation"><a href="#produktbeschreibung" aria-controls="produktbeschreibung" role="tab" data-toggle="tab">Produktbeschreibung</a></li>
		<li role="presentation"><a href="#jahresvergleich" aria-controls="jahresvergleich" role="tab" data-toggle="tab">Jahresvergleich</a></li>
</ul>

  <!-- Tab panes -->
  <div class="tab-content col-md-9">
    <div role="tabpanel" class="tab-pane active" id="einnahmen">
	
		<div class="row" id="rowx">
			<div class="col-sm-12">
				<div class="text-center" id="colx">
					<div id="chart_div" style="width:50%; text-align: center; margin-top: 20px;"></div>
				</div>
			</div>
		</div>	
	
	
	</div>
    <div role="tabpanel" class="tab-pane" id="ausgaben">	
		<div class="row" id="rowy">
			<div class="col-sm-12">
				<div class="text-center" id="coly">
					<div id="chart_divAusg" style="width:50%; text-align: center; margin-top: 20px;"></div>
				</div>
			</div>
		</div>	
	
	</div>
    <div role="tabpanel" class="tab-pane" id="tabelle">
	
		<div class="row">
			<div class="col-xs-12">
				Einnahmen
				<div id="table" style="width: 100%"></div>
				Ausgaben
				<div id="tableAusg" style="width: 100%"></div>
			</div>
		</div>	
	
	</div>
    <div role="tabpanel" class="tab-pane" id="produktbeschreibung">
	
	Produktbeschreibung hier hin
	
	</div>
    <div role="tabpanel" class="tab-pane" id="jahresvergleich">
	
	Jahresvergleich hier hin
	
	</div>
  </div>
  
	<div class="col-md-3">
	<div class="well">
		<div id="infoFieldPath"> Haushaltsstelle: <br /> <strong>____:_______________</strong></div>
		<div> 
			<br /><u>EinnahmenNav:</u> <br />
			<ul id="layer1E"> 
				<li>

					X<ul id="layer2E">
					</ul>
				</li>
			</ul>
			<br /> <u>AusgabenNav:</u>
			<ul id="layer1A"> 
				<li>

					Y<ul id="layer2A">
					</ul>
				</li>
			</ul>
		</div>
		
		<div style="margin-top: 20px;">
			<button id="button1" class="btn btn-primary" onclick="mainProposal()">Vorschlag einreichen</button>
		</div>
	</div>
	</div> 

</div>

<link rel="stylesheet"property="stylesheet"  href="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.22.1/css/theme.default.min.css" type="text/css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<script src="http://code.jquery.com/jquery-migrate-1.0.0.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/1.4.5/numeral.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.22.1/js/jquery.tablesorter.min.js"></script>
<script type="text/javascript">
	var einAusgaben=0;
	var forumURL = "./?q=forum"
	var map ={};
	map["PrBer11"] = 3;
	map["PrBer12"] = 14;
	map["PrBer21"] = 4;
	map["PrBer22"] = 4;
	map["PrBer23"] = 4;
	map["PrBer24"] = 13;
	map["PrBer26"] = 13;
	map["PrBer27"] = 13;
	map["PrBer28"] = 13;
	map["PrBer29"] = 13;
	map["PrBer31"] = 2;
	map["PrBer33"] = 2;
	map["PrBer34"] = 2;
	map["PrBer35"] = 2;
	map["PrBer36"] = 7;
	map["PrBer41"] = 8;
	map["PrBer42"] = 9;
	map["PrBer51"] = 10;
	map["PrBer52"] = 11;
	map["PrBer54"] = 12;
	map["PrBer55"] = 15;
	map["PrBer56"] = 17;
	map["PrBer57"] = 16;
	map["PrBer61"] = 19;
	var SIZE=800;
	var limit=4;	//Anzahl moglicher Ringe
	var xmlhttp = new XMLHttpRequest();         //used for ajax
	var DiaURL="./themes/IHR/data/main.php?q=";
	var gesamtSum;
	var Index=1;
	var selectedArr=[];
	var lastColor="";
	var colorRing=[];
	colorRing[0]='#4D4D4D';
	colorRing[1]='#5DA5DA';
	colorRing[2]='#FAA43A';
	//colorRing[3]='#B582CE';
	colorRing[3]='#60BD68';
	colorRing[4]='#F17CB0';
	colorRing[5]='#B2912F';
	colorRing[6]='#B276B2';
	colorRing[7]='#DECF3F';
	//colorRing[9]='#ff7f00';
	colorRing[8]='#F15854';
	colorRing[9]='#34426e';
	var colorRingIndex=0;
	var colorCountArr=[];
	var dataset =  {
	  layer1: [["PrNr1",53245,"Label1"], ["PrNr2",28479,"Label2"], ["PrNr3",19697,"Label3"], ["PrNr4",24037,"Label4"], ["PrNr5",40245,"Label5"]],

	};
	var aktDataset=[];

	var width = SIZE,
	    height = SIZE,
	    cwidth = 45;
	var infoFieldHeight=2/3*height/2;
	var infoFieldWidth=2/3*width/2;
	xmlhttp.onreadystatechange = function() {                     
		if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
			var str = JSON.parse(xmlhttp.responseText);                   //Daten werden geparsed
			aktDataset=str;
                        dataset["layer"+Index]=formatTable(str);   
			}
		};
	//die Anfragemethode und das Anfrageziel wird fesgelegt 	
	xmlhttp.open("GET",  DiaURL + "start", false);            
	xmlhttp.send();
	
	for(var col=0; col<limit; col++){
		colorCountArr[col]=0;
	}

//Utility--------------------------------------------------------------------------------------
	function formatTable(table){
		var result = [];
		var sonstiges = 0;
                gesamtSum = 0;
		for(var i = 1; i < table.length; i++) {   //ermitteln der Gesamtsumme des Datensatzes
			gesamtSum += table[i][1];
		}
		for(var j = 1; j < table.length; j++) {   // entscheidung ob ein datensatz einen zu kleinen Wert besitzt
			if((table[j][1]/gesamtSum) < 0.02) {
				sonstiges += table[j][1];
			}
			else {
				result.push(table[j]);
			}
		}
		
		// Hier muss noch gefixt werden
		result.push(['sonstiges',sonstiges,'sonstiges']);
		return result;
	}
	
	function formatTextSign(infoString){
            var infoStringArr=[];
            if((infoString.length>30)&&(infoString.search(",")>-1)){
                infoStringArr=infoString.split(",");
                infoString="";
                for(var t=0;t<infoStringArr.length; t++ ){
                    if(t<(infoStringArr.length-1)){
                        infoString+=infoStringArr[t]+", ";
                    }else{
                        infoString+=infoStringArr[t];
                    }
                }
            }
          
            infoStringArr=[];
            if((infoString.length>30)&&(infoString.search(".")>-1)){
                infoStringArr=infoString.split(".");
                infoString="";
                for(var t=0;t<infoStringArr.length; t++ ){
                    if(t<(infoStringArr.length-1)){
                        infoString+=infoStringArr[t]+". ";
                    }else{
                        infoString+=infoStringArr[t];
                    }
                }
            }
	    return infoString;
	}

	function convertToArray(d){
		var result=[];
		for(var i=0; i<d.length;i++){
			result.push(d[i][1]);
		}
		return result;
	}

	function getAllSelected() {
		var resultStr = "";
		for(var i = 0; i < selectedArr.length; i++) {
			resultStr = resultStr + selectedArr[i] + " ";
		}
	return resultStr;
	}
	
	function getColorByRing(d, i, j){
		colorCountArr[j]++;
		var result=colorRing[colorRingIndex];
		colorRingIndex++;
		if(colorRingIndex>9){colorRingIndex=0;}	
		return result;
	}

	function reduceColorIndex(p){
		while(p>0){
			p--;
			colorRingIndex--;
			if(colorRingIndex<0){colorRingIndex=9;}
		}
	}
	
	function getHaushaltsstelle(indexData, xData){
       var strHaus="";
       var strBez="";
       if(indexData==1){strHaus= dataset["layer"+indexData][xData][0]; strHaus=strHaus.substr(5,6); strHaus=strHaus+"__:__________";}
       if(indexData==2){strHaus= dataset["layer"+indexData][xData][0]; strHaus=strHaus.substr(4,6); strHaus=strHaus+"_:__________";}
       if(indexData==3){strHaus= dataset["layer"+indexData][xData][0]; strHaus=strHaus.substr(5,8); strHaus=strHaus+":__________";}
       if(indexData==4){strHaus= selectedArr[indexData-2]; strHaus=strHaus.substr(5,8); strHaus=strHaus+":"; strBez=dataset["layer"+indexData][xData][0]; strHaus=strHaus+strBez.substr(5,14);}
       return strHaus;
    }
//tabelle------------------------------------------------------------------------------
	function drawTable(array, theTable) {
		var arrayNames = ["Abteilung", "Betrag", "Posten", "Anteil"];
		var arrayNameslength = arrayNames.length;
		var arrayLength = array.length;
		if(arrayLength != null) {
			var arrayRange = array[0].length;
			var tr = document.createElement('tr');
			var thead = document.createElement('thead');
			var tb = document.createElement('tbody');
			
			for(var i = 0,th, textnode; i < arrayNameslength; i++) {
				th = document.createElement('th');
				
				textnode = document.createTextNode(arrayNames[i]); 
				th.appendChild(textnode);
				tr.appendChild(th);
				
				thead.appendChild(tr);
			}
			
			theTable.appendChild(thead);
  
			for (var i = 1, tr, td; i < arrayLength; i++) {
				tr = document.createElement('tr');
			   
				for(var j = 0; j < arrayRange; j++) {
					td = document.createElement('td');
					
					// Nummern im Betragsfeld formatieren, muss aber noch für deutsche Zahlenformatierung angepasst werden
					(j === 1) ? td.appendChild(document.createTextNode(numeral(array[i][j]).format('0,0'))) : td.appendChild(document.createTextNode(array[i][j]));
					
					tr.appendChild(td);
				}
				
				// Anteile
				td = document.createElement('td');
				
				td.appendChild(document.createTextNode(numeral(array[i][1]/gesamtSum).format('0.00%')));
				tr.appendChild(td);
				tr.setAttribute('indexNummer',i);
			
				// Tabelle klickbar machen
				tr.onclick=(function(){
					var name=this.firstChild.innerHTML;
					clickFunction("",this.getAttribute('indexNummer'), dataset.length -1, name);
				});
				tb.appendChild(tr);
			}
			
			theTable.appendChild(tb);

			// Tabelle an div
			jQuery(document).ready(function(){
				document.getElementById('table').appendChild(theTable);
			});
		}
	}
	
	function clearTable(theTable) {
		theTable.innerHTML = "";
	}

//main---------------------------------------------------------------------------------	

	var color = d3.scale.category20();

	var pie = d3.layout.pie()
	    .sort(null);

	var arc = d3.svg.arc();
	
	function cutOffArray(i){
		var rewind=0;
		for(var cut=limit; cut>(i+1); cut--)
		{
			rewind+=colorCountArr[cut-1];
			colorCountArr[cut-1]=0;
			if(!(dataset["layer"+cut]==undefined)){
				delete dataset["layer"+cut]; 
				Index--;
				selectedArr.pop();
			}
		}
		reduceColorIndex(rewind);
		gs = svg.selectAll("g").data(d3.values(dataset)).exit().remove();
	}
	
    var clickFunction=function(d, i, j, k){
		var goon=false;
		cutOffArray(j);
		if(k!=undefined)
			{document.getElementById("layer"+Index+"E").innerHTML = "<li> "+formatTextSign(aktDataset[i][2])+ '<ul id="layer'+(Index+1)+'E"></ul></li>';}
		else
			{document.getElementById("layer"+Index+"E").innerHTML = "<li> "+formatTextSign(dataset["layer"+ Index][i][2])+ '<ul id="layer'+(Index+1)+'E"></ul></li>';}
		if(Index<limit){
			if(k!=undefined){selectedArr.push(k); goon=true;}
			else {selectedArr.push(dataset["layer"+ (j+1)][i][0]); goon=true;}
			if(goon){
				Index++;
				xmlhttp.open("GET",  DiaURL + getAllSelected(), false);            
				xmlhttp.send();
				gs = svg.selectAll("g").data(d3.values(dataset)).enter().append("g");
				gs = svg.selectAll("g");
				path = gs.selectAll("path")
					.data(function(d) { return pie(convertToArray(d)); })
				.enter().append("path")
					.attr("fill", getColorByRing)
					.attr("d", function(d, i, j, k) { return arc.innerRadius(20+cwidth*(j+4)).outerRadius(15+cwidth*(j+5))(d); })
					.on('click', clickFunction)
					.on('mouseover', mouseoverFunction)
					.on('mouseout',function(){ d3.select(this).attr("fill",lastColor);});
				clearTable(theTable);
				tabledata = aktDataset;
				drawTable(tabledata,theTable);
			}
		}
	}

	/**
	*@param {Objekt} d Datenobjekt des Segments
	*@param {integer} i Arraynummer des Segments 	
	*@param {integer} j Arraynummer des Kreises
	*/
	var mouseoverFunction= function(d, i, j){
		//console.log(j+" "+Index);
		lastColor=d3.select(this).attr("fill");
		d3.select(this).attr("fill","#EBFF33");
		
            var infoString=formatTextSign(dataset["layer"+(j+1)][i][2]);

        document.getElementById("infoFieldData").innerHTML = "<h3>" + infoString + "</h3><h4>Einnahmen in Euro: " + numeral(dataset["layer"+(j+1)][i][1]).format('0,0') + "</h4>";
		document.getElementById("infoFieldPath").innerHTML="Haushaltsstelle: <br />  <strong>"+getHaushaltsstelle(j+1, i)+"</strong>";
	}
	
	var chartDiv=d3.select("#chart_div")
		.attr("style","position:relative; width: "+width +"px; height: "+height+"px;  border-style: solid; border-width: 1px;");

	var svg = d3.select("#chart_div").append("svg")
	    .attr("width", width)
	    .attr("height", height)
	    .attr("id", "pieSVG")
	    .append("g")
	    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

	var gs = svg.selectAll("g").data(d3.values(dataset)).enter().append("g");
	var path = gs.selectAll("path")
	    .data(function(d) { return pie(convertToArray(d)); })
	  .enter().append("path")
	    .attr("fill", getColorByRing)//.attr("fill", function(d, i) { return color(i); })
	    .attr("d", function(d, i, j) { return arc.innerRadius(20+cwidth*(j+4)).outerRadius(15+cwidth*(j+5))(d); })
	    .on('click', clickFunction)
	    .on('mouseover', mouseoverFunction)
		.on('mouseout',function(){ d3.select(this).attr("fill",lastColor);});

	var infoField =d3.select("#chart_div").append("div")
		.attr("id", "infoFieldData")
		.attr("style","position: absolute; top:"+ (height-infoFieldHeight)/2 +"px ; left: "+(width-infoFieldWidth)/2 +"px ; width: "+infoFieldWidth +"px; height: "+infoFieldHeight+"px; border-style: solid; border-width: 0px; z-index: 1; text-align: center;")
		.text("start" );
	document.getElementById("infoFieldData").innerHTML = "<h3>Kommunaler Haushalt des Jahres 2014</h3><h4>Gesamteinnahmen in Euro: " + numeral(gesamtSum).format('0,0') + "</h4>";


	// Tabelle vorbereiten	
	var tabledata = aktDataset;
	var theTable = document.createElement('table');
	jQuery(theTable).css("width", "100%");
	jQuery(theTable).attr({'id': 'inner-table', 'class': 'table table-striped table-hover table-bordered'});
	
	// Tabelle generieren
	drawTable(tabledata,theTable);
	// Tabelle sortieren
	jQuery("#inner-table").tablesorter( {sortList: [[1,1], [2,0]]} ); 
	    
	
	
/**
* Funktion zum Generieren des Links fuer den "Vorschlag einreichen"-Buttons
*/
function proposal(array) {
if(!(jQuery("body.not-logged-in").length>0)) //check if logged in
{
	var tmp = selectedArr[0];
	
	if(typeof tmp === 'undefined') {
		window.open(forumURL);
	}
	else {
		if(tmp in map)
		{
			tmp = map[tmp];
			var url = forumURL + "/" + tmp + "#overlay=%3Fq%3Dnode%252Fadd%252Fforum%252F" + tmp;
			window.open(url);
		}
		else
			window.open(forumURL);
	}
}
else
{
alert("Für diese Funktion müssen sie sich einloggen")
}
}
d3.select("#EinnahmenT").on('click',function (){einAusgaben=0;});
</script>
<script type="text/javascript">
	var forumURL = "./?q=forum"
	var xmlhttpAusg = new XMLHttpRequest();         //used for ajax
	var DiaURLAusg="./themes/IHR/data/mainAusgabe.php?q=";
	var gesamtSumAusg;
	var IndexAusg=1;
	var selectedArrAusg=[];
	var lastColorAusg="";
	var colorRing=[];
	colorRing[0]='#4D4D4D';
	colorRing[1]='#5DA5DA';
	colorRing[2]='#FAA43A';
	//colorRing[3]='#B582CE';
	colorRing[3]='#60BD68';
	colorRing[4]='#F17CB0';
	colorRing[5]='#B2912F';
	colorRing[6]='#B276B2';
	colorRing[7]='#DECF3F';
	//colorRing[9]='#ff7f00';
	colorRing[8]='#F15854';
	colorRing[9]='#34426e';
	var colorRingIndexAusg=0;
	var colorCountArrAusg=[];
	var datasetAusg =  {
	  layer1: [["PrNr1",53245,"Label1"], ["PrNr2",28479,"Label2"], ["PrNr3",19697,"Label3"], ["PrNr4",24037,"Label4"], ["PrNr5",40245,"Label5"]],

	};
	var aktDatasetAusg=[];
	var width = SIZE,
	    height = SIZE,
	    cwidth = 45;
	var infoFieldHeight=2/3*height/2;
	var infoFieldWidth=2/3*width/2;
	xmlhttpAusg.onreadystatechange = function() {                     
		if (xmlhttpAusg.readyState == 4 && xmlhttpAusg.status == 200) {
			var str = JSON.parse(xmlhttpAusg.responseText);                   //Daten werden geparsed
			for(var i = 1; i < str.length; i++) {   //ermitteln der Gesamtsumme des Datensatzes
				str[i][1]= str[i][1]*(-1);
			}
			aktDatasetAusg=str;
			datasetAusg["layer"+IndexAusg]=formatTableAusg(str);   
		}
	};
	//die Anfragemethode und das Anfrageziel wird fesgelegt 	
	xmlhttpAusg.open("GET",  DiaURLAusg + "start", false);            
	xmlhttpAusg.send();
	
	for(var col=0; col<limit; col++){
		colorCountArrAusg[col]=0;
	}

//Utility--------------------------------------------------------------------------------------
	function formatTableAusg(table){
		var result = [];
		var sonstiges = 0;
                gesamtSumAusg = 0;
		for(var i = 1; i < table.length; i++) {   //ermitteln der Gesamtsumme des Datensatzes
			gesamtSumAusg += table[i][1];
		}
		for(var j = 1; j < table.length; j++) {   // entscheidung ob ein datensatz einen zu kleinen Wert besitzt
			if((table[j][1]/gesamtSumAusg) < 0.02) {
				sonstiges += table[j][1];
			}
			else {
				result.push(table[j]);
			}
		}
		
		// Hier muss noch gefixt werden
		result.push(['sonstiges',sonstiges,'sonstiges']);
		return result;
	}

	function convertToArrayAusg(d){
		var result=[];
		for(var i=0; i<d.length;i++){
			result.push(d[i][1]);
		}
		return result;
	}

	function getAllSelectedAusg() {
		var resultStr = "";
		for(var i = 0; i < selectedArrAusg.length; i++) {
			resultStr = resultStr + selectedArrAusg[i] + " ";
		}
		return resultStr;
	}
	
	function getColorByRingAusg(d, i, j){
		colorCountArrAusg[j]++;
		var result=colorRing[colorRingIndexAusg];
		colorRingIndexAusg++;
		if(colorRingIndexAusg>9){colorRingIndexAusg=0;}	
		return result;
	}

	function reduceColorIndexAusg(p){
		while(p>0){
			p--;
			colorRingIndexAusg--;
			if(colorRingIndexAusg<0){colorRingIndexAusg=9;}
		}
	}
	
	function getHaushaltsstelleAusg(indexData, xData){
       var strHaus="";
       var strBez="";
       if(indexData==1){strHaus= datasetAusg["layer"+indexData][xData][0]; strHaus=strHaus.substr(5,6); strHaus=strHaus+"__:__________";}
       if(indexData==2){strHaus= datasetAusg["layer"+indexData][xData][0]; strHaus=strHaus.substr(4,6); strHaus=strHaus+"_:__________";}
       if(indexData==3){strHaus= datasetAusg["layer"+indexData][xData][0]; strHaus=strHaus.substr(5,8); strHaus=strHaus+":__________";}
       if(indexData==4){strHaus= selectedArrAusg[indexData-2]; strHaus=strHaus.substr(5,8); strHaus=strHaus+":"; strBez=datasetAusg["layer"+indexData][xData][0]; strHaus=strHaus+strBez.substr(5,14);}
       return strHaus;
    }
//tabelle------------------------------------------------------------------------------
	function drawTableAusg(array, theTableAusg) {
		var arrayNames = ["Abteilung", "Betrag", "Posten", "Anteil"];
		var arrayNameslength = arrayNames.length;
		var arrayLength = array.length;
		if(arrayLength != null) {
			var arrayRange = array[0].length;
			var tr = document.createElement('tr');
			var thead = document.createElement('thead');
			var tb = document.createElement('tbody');
			
			for(var i = 0,th, textnode; i < arrayNameslength; i++) {
				th = document.createElement('th');
				
				textnode = document.createTextNode(arrayNames[i]); 
				th.appendChild(textnode);
				tr.appendChild(th);
				
				thead.appendChild(tr);
			}
			
			theTableAusg.appendChild(thead);
  
			for (var i = 1, tr, td; i < arrayLength; i++) {
				tr = document.createElement('tr');
			   
				for(var j = 0; j < arrayRange; j++) {
					td = document.createElement('td');
					
					// Nummern im Betragsfeld formatieren, muss aber noch für deutsche Zahlenformatierung angepasst werden
					(j === 1) ? td.appendChild(document.createTextNode(numeral(array[i][j]).format('0,0'))) : td.appendChild(document.createTextNode(array[i][j]));
					
					tr.appendChild(td);
				}
				
				// Anteile
				td = document.createElement('td');
				
				td.appendChild(document.createTextNode(numeral(array[i][1]/gesamtSumAusg).format('0.00%')));
				tr.appendChild(td);
				tr.setAttribute('indexNummer',i);
			
				// Tabelle klickbar machen
				tr.onclick=(function (){
					var name=this.firstChild.innerHTML;
					clickFunctionAusg("",this.getAttribute('indexNummer'), datasetAusg.length -1, name);
				})
				tb.appendChild(tr);
			}
			
			theTableAusg.appendChild(tb);

			// Tabelle an div
			jQuery(document).ready(function(){
				document.getElementById('tableAusg').appendChild(theTableAusg);
			});
		}
	}
	
	function clearTableAusg(theTableAusg) {
		theTableAusg.innerHTML = "";
	}

//main---------------------------------------------------------------------------------	

	var color = d3.scale.category20();

	var pieAusg = d3.layout.pie()
	    .sort(null);

	var arcAusg = d3.svg.arc();
	
	function cutOffArrayAusg(i){
		var rewind=0;
		for(var cut=limit; cut>(i+1); cut--)
		{
			rewind+=colorCountArrAusg[cut-1];
			colorCountArrAusg[cut-1]=0;
			if(!(datasetAusg["layer"+cut]==undefined)){
				delete datasetAusg["layer"+cut]; 
				IndexAusg--;
				selectedArrAusg.pop();
			}
		}
		reduceColorIndexAusg(rewind);
		gsAusg = svgAusg.selectAll("g").data(d3.values(datasetAusg)).exit().remove();
	}
	
    var clickFunctionAusg=function(d, i, j, k){
		var goon=false;
		cutOffArrayAusg(j);
		if(k!=undefined)
			{document.getElementById("layer"+IndexAusg+"A").innerHTML = "<li> "+formatTextSign(aktDatasetAusg[i][2])+ '<ul id="layer'+(IndexAusg+1)+'A"></ul></li>';}
		else
			{document.getElementById("layer"+IndexAusg+"A").innerHTML = "<li> "+formatTextSign(datasetAusg["layer"+ IndexAusg][i][2])+ '<ul id="layer'+(IndexAusg+1)+'A"></ul></li>';}
		
		if(IndexAusg<limit){
			if(k!=undefined){selectedArrAusg.push(k); goon=true;}
			else {selectedArrAusg.push(datasetAusg["layer"+ (j+1)][i][0]); goon=true;}
			if(goon){
				IndexAusg++;
				xmlhttpAusg.open("GET",  DiaURLAusg + getAllSelectedAusg(), false);            
				xmlhttpAusg.send();
				gsAusg = svgAusg.selectAll("g").data(d3.values(datasetAusg)).enter().append("g");
				gsAusg = svgAusg.selectAll("g");
				pathAusg = gsAusg.selectAll("path")
					.data(function(d) { return pieAusg(convertToArrayAusg(d)); })
				.enter().append("path")
					.attr("fill", getColorByRingAusg)
					.attr("d", function(d, i, j, k) { return arcAusg.innerRadius(20+cwidth*(j+4)).outerRadius(15+cwidth*(j+5))(d); })
					.on('click', clickFunctionAusg)
					.on('mouseover', mouseoverFunctionAusg)
					.on('mouseout',function(){ d3.select(this).attr("fill",lastColorAusg);});
				clearTableAusg(theTableAusg);
				tabledataAusg = aktDatasetAusg;
				drawTableAusg(tabledataAusg,theTableAusg);
			}
		}
	}

	/**
	*@param {Objekt} d Datenobjekt des Segments
	*@param {integer} i Arraynummer des Segments 	
	*@param {integer} j Arraynummer des Kreises
	*/
	var mouseoverFunctionAusg= function(d, i, j){
		//console.log(j+" "+IndexAusg);
		lastColorAusg=d3.select(this).attr("fill");
		d3.select(this).attr("fill","#EBFF33");
		
            var infoString=formatTextSign(datasetAusg["layer"+(j+1)][i][2]);
            
        	document.getElementById("infoFieldDataAusg").innerHTML = "<h3>" + infoString + "</h3><h4>Ausgaben in Euro: " + numeral(datasetAusg["layer"+(j+1)][i][1]).format('0,0') + "</h4>";
		document.getElementById("infoFieldPath").innerHTML="Haushaltsstelle:<br />  <strong>"+getHaushaltsstelleAusg(j+1, i)+"</strong>";
	}
	
	var chartDivAusg=d3.select("#chart_divAusg")
		.attr("style","position:relative; width: "+width +"px; height: "+height+"px;  border-style: solid; border-width: 1px;");

	var svgAusg = d3.select("#chart_divAusg").append("svg")
	    .attr("width", width)
	    .attr("height", height)
	    .attr("id", "pieSVG")
	    .append("g")
	    .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

	var gsAusg = svgAusg.selectAll("g").data(d3.values(datasetAusg)).enter().append("g");
	var pathAusg = gsAusg.selectAll("path")
	    .data(function(d) { return pieAusg(convertToArrayAusg(d)); })
	  .enter().append("path")
	    .attr("fill", getColorByRingAusg)//.attr("fill", function(d, i) { return color(i); })
	    .attr("d", function(d, i, j) { return arcAusg.innerRadius(20+cwidth*(j+4)).outerRadius(15+cwidth*(j+5))(d); })
	    .on('click', clickFunctionAusg)
	    .on('mouseover', mouseoverFunctionAusg)
		.on('mouseout',function(){ d3.select(this).attr("fill",lastColorAusg);});

	var infoFieldAusg =d3.select("#chart_divAusg").append("div")
		.attr("id", "infoFieldDataAusg")
		.attr("style","position: absolute; top:"+ (height-infoFieldHeight)/2 +"px ; left: "+(width-infoFieldWidth)/2 +"px ; width: "+infoFieldWidth +"px; height: "+infoFieldHeight+"px; border-style: solid; border-width: 0px; z-index: 1; text-align: center;")
		.text("start" );
	document.getElementById("infoFieldDataAusg").innerHTML = "<h3>Kommunaler Haushalt des Jahres 2014</h3><h4>Gesamtausgaben in Euro: " + numeral(gesamtSumAusg).format('0,0') + "</h4>";
    function urlPathDia(){
        var sUrl=window.location.search.substring(1);
        var aUrl=sUrl.split("/");
        var urlIndex=3;
        var breakFlag=false;
	var EAFlag=true;
	if(aUrl[2]=="E"){ EAFlag=true; breakFlag=true; document.getElementById("EinnahmenT").click(); document.getElementById("EinnahmenHref").click(); }
	else {if(aUrl[2]=="A"){EAFlag=false; breakFlag=true; document.getElementById("AusgabenT").click(); document.getElementById("AusgabenHref").click();}}
        for(urlIndex=3;(urlIndex<aUrl.length)&&(urlIndex<5)&&breakFlag;urlIndex++){
            if(aUrl[urlIndex]=="N"){
                breakFlag=false;
            }else{
		if(EAFlag){
			for(var i=0; i<aktDataset.length; i++){
				if(aktDataset[i][0]==aUrl[urlIndex]){
					clickFunction("", i, dataset.length -1, aUrl[urlIndex]);
				}
			}
		}else{
			for(var i=0; i<aktDatasetAusg.length; i++){
				if(aktDatasetAusg[i][0]==aUrl[urlIndex]){
					clickFunctionAusg("", i, datasetAusg.length -1, aUrl[urlIndex]);
				}
			}				
		}
           }         
        }
    }

	// Tabelle vorbereiten	
	var tabledataAusg = aktDatasetAusg;
	var theTableAusg = document.createElement('table');
	jQuery(theTableAusg).css("width", "100%");
	jQuery(theTableAusg).attr({'id': 'inner-tableAusg', 'class': 'table table-striped table-hover table-bordered'});
	
	// Tabelle generieren
	drawTableAusg(tabledataAusg,theTableAusg);
	// Tabelle sortieren
	jQuery("#inner-tableAusg").tablesorter( {sortList: [[1,1], [2,0]]} ); 
	    
urlPathDia();
	
	
/**
* Funktion zum Generieren des Links fuer den "Vorschlag einreichen"-Buttons
*/
function proposalAusg(array) {
	if(!(jQuery("body.not-logged-in").length>0)) //check if logged in
	{
		var tmp = selectedArrAusg[0];
	
		if(typeof tmp === 'undefined') {
			window.open(forumURL);
		}
		else {
			if(tmp in map)
			{
				tmp = map[tmp];
				var url = forumURL + "/" + tmp + "#overlay=%3Fq%3Dnode%252Fadd%252Fforum%252F" + tmp;
				window.open(url);
			}
			else
				window.open(forumURL);
		}
	}
	else
	{
		alert("Für diese Funktion müssen sie sich einloggen")
	}
}

d3.select("#AusgabenT").on('click',function (){einAusgaben=1; });

function mainProposal(array){
	if(einAusgaben==0){
		proposal(array);
	}
	else{
		proposalAusg(array);
	}
}
</script>
<script type="text/javascript">
jQuery.fn.extend({
    treed: function (o) {
      
      var openedClass = 'glyphicon-minus-sign';
      var closedClass = 'glyphicon-plus-sign';
      
      if (typeof o != 'undefined'){
        if (typeof o.openedClass != 'undefined'){
        openedClass = o.openedClass;
        }
        if (typeof o.closedClass != 'undefined'){
        closedClass = o.closedClass;
        }
      };
      
        //initialize each of the top levels
        var tree = jQuery(this);
        tree.addClass("tree");
        tree.find('li').has("ul").each(function () {
            var branch = jQuery(this); //li with children ul
            branch.prepend("<i class='indicator glyphicon " + openedClass + "'></i>");
            branch.addClass('branch');
            branch.on('click', function (e) {
                if (this == e.target) {
                    var icon = jQuery(this).children('i:first');
                    icon.toggleClass(closedClass + " " + openedClass);
                    jQuery(this).children().children().toggle();
                }
            })
            //branch.children().children().toggle();
        });
        //fire event from the dynamically added icon
      tree.find('.branch .indicator').each(function(){
        jQuery(this).on('click', function () {
            jQuery(this).closest('li').click();
        });
      });
        //fire event to open branch if the li contains an anchor instead of text
        tree.find('.branch>a').each(function () {
            jQuery(this).on('click', function (e) {
                jQuery(this).closest('li').click();
                e.preventDefault();
            });
        });
        //fire event to open branch if the li contains a button instead of text
        tree.find('.branch>button').each(function () {
            jQuery(this).on('click', function (e) {
                jQuery(this).closest('li').click();
                e.preventDefault();
            });
        });
    }
});

//Initialization of treeviews

jQuery('#tree1').treed({openedClass:'glyphicon-chevron-right', closedClass:'glyphicon-chevron-down'});

</script>
